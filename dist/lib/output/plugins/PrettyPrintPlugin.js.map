{"version":3,"file":"PrettyPrintPlugin.js","sourceRoot":"","sources":["../../../../src/lib/output/plugins/PrettyPrintPlugin.ts"],"names":[],"mappings":"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","sourcesContent":["import { Component, RendererComponent } from '../components';\r\nimport { PageEvent } from '../events';\r\n\r\n/**\r\n * List of states the parser of [[PrettyPrintPlugin]] can be in.\r\n */\r\nenum PrettyPrintState {\r\n    /**\r\n     * Default state of the parser. Empty lines will be removed and indention will be adjusted.\r\n     */\r\n    Default,\r\n\r\n    /**\r\n     * Comment state, the parser waits for a comment closing tag.\r\n     */\r\n    Comment,\r\n\r\n    /**\r\n     * Pre state, the parser waits for the closing tag of the current pre block.\r\n     */\r\n    Pre\r\n}\r\n\r\n/**\r\n * A plugin that pretty prints the generated html.\r\n *\r\n * This not only aids in making the generated html source code more readable, by removing\r\n * blank lines and unnecessary whitespaces the size of the documentation is reduced without\r\n * visual impact.\r\n *\r\n * At the point writing this the docs of TypeDoc took 97.8 MB  without and 66.4 MB with this\r\n * plugin enabled, so it reduced the size to 68% of the original output.\r\n */\r\n@Component({name: 'pretty-print'})\r\nexport class PrettyPrintPlugin extends RendererComponent {\r\n    /**\r\n     * Map of all tags that will be ignored.\r\n     */\r\n    static IGNORED_TAGS: any = {\r\n        area:    true,\r\n        base:    true,\r\n        br:      true,\r\n        wbr:     true,\r\n        col:     true,\r\n        command: true,\r\n        embed:   true,\r\n        hr:      true,\r\n        img:     true,\r\n        input:   true,\r\n        link:    true,\r\n        meta:    true,\r\n        param:   true,\r\n        source:  true\r\n    };\r\n\r\n    /**\r\n     * Map of all tags that prevent this plugin form modifying the following code.\r\n     */\r\n    static PRE_TAGS: any = {\r\n        pre:      true,\r\n        code:     true,\r\n        textarea: true,\r\n        script:   true,\r\n        style:    true\r\n    };\r\n\r\n    /**\r\n     * Create a new PrettyPrintPlugin instance.\r\n     */\r\n    initialize() {\r\n        this.listenTo(this.owner, PageEvent.END, this.onRendererEndPage, -1024);\r\n    }\r\n\r\n    /**\r\n     * Triggered after a document has been rendered, just before it is written to disc.\r\n     *\r\n     * @param event\r\n     */\r\n    onRendererEndPage(event: PageEvent) {\r\n        let match: RegExpMatchArray;\r\n        let line: string;\r\n        let lineState: PrettyPrintState;\r\n        let lineDepth: number;\r\n        let tagName: string;\r\n        let preName: string;\r\n\r\n        let tagExp       = /<\\s*(\\w+)[^>]*>|<\\/\\s*(\\w+)[^>]*>|<!--|-->/g;\r\n        let emptyLineExp = /^[\\s]*$/;\r\n        let minLineDepth = 1;\r\n        let state        = PrettyPrintState.Default;\r\n        const stack: string[] = [];\r\n\r\n        const lines        = event.contents.split(/\\r\\n?|\\n/);\r\n        let index        = 0;\r\n        let count        = lines.length;\r\n\r\n        while (index < count) {\r\n            line = lines[index];\r\n            if (emptyLineExp.test(line)) {\r\n                if (state === PrettyPrintState.Default) {\r\n                    lines.splice(index, 1);\r\n                    count -= 1;\r\n                    continue;\r\n                }\r\n            } else {\r\n                lineState = state;\r\n                lineDepth = stack.length;\r\n\r\n                while (match = tagExp.exec(line)) {\r\n                    if (state === PrettyPrintState.Comment) {\r\n                        if (match[0] === '-->') {\r\n                            state = PrettyPrintState.Default;\r\n                        }\r\n                    } else if (state === PrettyPrintState.Pre) {\r\n                        if (match[2] && match[2].toLowerCase() === preName) {\r\n                            state = PrettyPrintState.Default;\r\n                        }\r\n                    } else {\r\n                        if (match[0] === '<!--') {\r\n                            state = PrettyPrintState.Comment;\r\n                        } else if (match[1]) {\r\n                            tagName = match[1].toLowerCase();\r\n                            if (tagName in PrettyPrintPlugin.IGNORED_TAGS) {\r\n                                continue;\r\n                            }\r\n                            if (tagName in PrettyPrintPlugin.PRE_TAGS) {\r\n                                state = PrettyPrintState.Pre;\r\n                                preName = tagName;\r\n                            } else {\r\n                                if (tagName === 'body') {\r\n                                    minLineDepth = 2;\r\n                                }\r\n                                stack.push(tagName);\r\n                            }\r\n                        } else if (match[2]) {\r\n                            tagName = match[2].toLowerCase();\r\n                            if (tagName in PrettyPrintPlugin.IGNORED_TAGS) {\r\n                                continue;\r\n                            }\r\n\r\n                            const n = stack.lastIndexOf(tagName);\r\n                            if (n !== -1) {\r\n                                stack.length = n;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n                if (lineState === PrettyPrintState.Default) {\r\n                    lineDepth = Math.min(lineDepth, stack.length);\r\n                    line = line.replace(/^\\s+/, '').replace(/\\s+$/, '');\r\n                    if (lineDepth > minLineDepth) {\r\n                        line = Array(lineDepth - minLineDepth + 1).join('\\t') + line;\r\n                    }\r\n\r\n                    lines[index] = line;\r\n                }\r\n            }\r\n\r\n            index++;\r\n        }\r\n\r\n        event.contents = lines.join('\\n');\r\n    }\r\n}\r\n"]}